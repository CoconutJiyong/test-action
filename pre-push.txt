#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 🔹 보호된 브랜치(main, develop) 직접 푸시 방지
protected_branches=("main" "develop")
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo "❌ Pushing directly to the '$current_branch' branch is not allowed."
    exit 1
  fi
done

echo "🔍 Checking for modified .tsx files in packages/components..."

# 🔹 feature 브랜치가 develop에서 분기된 이후 변경된 파일 가져오기
BASE_COMMIT=$(git merge-base origin/develop HEAD)
CHANGED_FILES=$(git diff --name-only --diff-filter=AM "$BASE_COMMIT" HEAD | sort -u)
echo "📝 Full changed files list (since feature branch creation):"
echo "$CHANGED_FILES"

# 🔹 packages/components 내부 변경된 파일만 필터링
MODIFIED_COMPONENTS=$(echo "$CHANGED_FILES" | grep '^packages/components/.*\.tsx$' || true)

if [ -z "$MODIFIED_COMPONENTS" ]; then
  echo "✅ No .tsx file changes detected in packages/components."
  exit 0
fi

echo "🔍 Analyzing modified components:"
echo "$MODIFIED_COMPONENTS"

# 🔹 변경된 .tsx 파일에서 .stories.tsx, .stories.ts, .mdx 존재 여부 확인
MISSING_STORYBOOK=""
MODIFIED_STORYBOOK=""
for FILE in $MODIFIED_COMPONENTS; do
  BASE_NAME=$(echo "$FILE" | sed 's/\.tsx$//')
  STORIES_FILES="${BASE_NAME}.stories.tsx ${BASE_NAME}.stories.ts ${BASE_NAME}.mdx"

  FOUND_STORYBOOK=""
  for STORY in $STORIES_FILES; do
    if [ -f "$STORY" ]; then
      FOUND_STORYBOOK="$STORY"
      echo "📖 Found Storybook file: $FOUND_STORYBOOK"
      MODIFIED_STORYBOOK="$MODIFIED_STORYBOOK\n$FOUND_STORYBOOK"
      break
    fi
  done

  if [ -z "$FOUND_STORYBOOK" ]; then
    echo "🚨 Missing Storybook file for: $FILE"
    MISSING_STORYBOOK="$MISSING_STORYBOOK\n$FILE"
  else
    # ✅ 스토리북 파일이 존재하면 MISSING_STORYBOOK에서 제거
    MISSING_STORYBOOK=$(echo "$MISSING_STORYBOOK" | grep -v "$FILE" || true)
  fi
done

# 🔹 스토리북 파일이 없으면 push 중단
if [ -n "$MISSING_STORYBOOK" ]; then
  echo "❌ Some components are missing Storybook files! Please add them."
  echo "$MISSING_STORYBOOK"
  exit 1
fi

# 🔹 변경된 스토리북 파일이 있는지 확인
STORYBOOK_CHANGES=""
for FILE in $(echo "$MODIFIED_STORYBOOK"); do
  if echo "$CHANGED_FILES" | grep -q "$FILE"; then
    STORYBOOK_CHANGES="$STORYBOOK_CHANGES\n$FILE"
    echo "✅ Storybook modified: $FILE"
  fi
done

# 🔹 변경된 스토리북 파일이 없으면 push 중단
if [ -z "$STORYBOOK_CHANGES" ]; then
  echo "❌ No modifications detected in corresponding Storybook files!"
  exit 1
fi

echo "✅ All conditions met. Proceeding with push!"
exit 0
