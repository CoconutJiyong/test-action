#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

protected_branches=("main" "develop")
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo "âŒ Pushing directly to the '$current_branch' branch is not allowed."
    exit 1
  fi
done

# âœ… ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ íŒŒì¼ í™•ì¸ (origin/developê³¼ ë¹„êµ)
echo "ğŸ” Checking for modified .tsx/.jsx files in packages/components..."
components_changed=$(git diff --name-only origin/develop --diff-filter=AM | grep -E '^packages/components/' | grep -E '\.(tsx|jsx)$')
echo "ğŸ“„ Modified components: $components_changed"

missing_stories=()
unchanged_stories=()

if [ -n "$components_changed" ]; then
  while IFS= read -r file; do
    component_dir=$(dirname "$file")
    echo "ğŸ“ Checking directory: $component_dir"

    # âœ… ìŠ¤í† ë¦¬ë¶ íŒŒì¼ ëª©ë¡ í™•ì¸
    story_files=$(find "$component_dir" -maxdepth 1 -type f \( -name "*.stories.tsx" -o -name "*.stories.ts" -o -name "*.stories.mdx" \))

    if [ -z "$story_files" ]; then
      echo "âŒ No Storybook file found for $file"
      missing_stories+=("$file")
    else
      echo "ğŸ“– Found Storybook files:"
      echo "$story_files"

      # âœ… í•´ë‹¹ Storybook íŒŒì¼ë“¤ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      story_changed=$(git diff --name-only origin/develop --diff-filter=AM | grep -F -x -f <(echo "$story_files"))

      if [ -z "$story_changed" ]; then
        echo "âš ï¸ Storybook file exists but was NOT modified: $story_files"
        unchanged_stories+=("$file")
      else
        echo "âœ… Storybook file was modified: $story_changed"
      fi
    fi
  done <<< "$components_changed"
fi

# ğŸš¨ Push ì°¨ë‹¨ ì¡°ê±´
if [ ${#missing_stories[@]} -gt 0 ]; then
  echo "âŒ [ERROR] Push blocked: The following components have no corresponding Storybook file:"
  for file in "${missing_stories[@]}"; do
    echo "   - $file"
  done
  echo "ğŸ“Œ Please create a '.stories.tsx', '.stories.ts', or '.stories.mdx' file in the same directory."
  exit 1
fi

if [ ${#unchanged_stories[@]} -gt 0 ]; then
  echo "âŒ [ERROR] Push blocked: The following components were modified, but their Storybook files were not updated:"
  for file in "${unchanged_stories[@]}"; do
    echo "   - $file"
  done
  echo "ğŸ“Œ Please update the corresponding '.stories.tsx', '.stories.ts', or '.stories.mdx' file."
  exit 1
fi

echo "âœ… All checks passed. Proceeding with push."
exit 0
