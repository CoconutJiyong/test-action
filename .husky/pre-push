#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

protected_branches=("main" "develop")
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo "❌ Pushing directly to the '$current_branch' branch is not allowed."
    exit 1
  fi
done

# ✅ 변경된 컴포넌트 파일 확인 (origin/develop과 비교)
echo "🔍 Checking for modified .tsx/.jsx files in packages/components..."
components_changed=$(git diff --name-only origin/develop --diff-filter=AM | grep -E '^packages/components/' | grep -E '\.(tsx|jsx)$')
echo "📄 Modified components: $components_changed"

missing_stories=()
unchanged_stories=()

if [ -n "$components_changed" ]; then
  while IFS= read -r file; do
    component_dir=$(dirname "$file")
    echo "📁 Checking directory: $component_dir"

    # ✅ 스토리북 파일 목록 확인
    story_files=$(find "$component_dir" -maxdepth 1 -type f \( -name "*.stories.tsx" -o -name "*.stories.ts" -o -name "*.stories.mdx" \))

    if [ -z "$story_files" ]; then
      echo "❌ No Storybook file found for $file"
      missing_stories+=("$file")
    else
      echo "📖 Found Storybook files:"
      echo "$story_files"

      # ✅ 해당 Storybook 파일들이 변경되었는지 확인
      story_changed=$(git diff --name-only origin/develop --diff-filter=AM | grep -F -x -f <(echo "$story_files"))

      if [ -z "$story_changed" ]; then
        echo "⚠️ Storybook file exists but was NOT modified: $story_files"
        unchanged_stories+=("$file")
      else
        echo "✅ Storybook file was modified: $story_changed"
      fi
    fi
  done <<< "$components_changed"
fi

# 🚨 Push 차단 조건
if [ ${#missing_stories[@]} -gt 0 ]; then
  echo "❌ [ERROR] Push blocked: The following components have no corresponding Storybook file:"
  for file in "${missing_stories[@]}"; do
    echo "   - $file"
  done
  echo "📌 Please create a '.stories.tsx', '.stories.ts', or '.stories.mdx' file in the same directory."
  exit 1
fi

if [ ${#unchanged_stories[@]} -gt 0 ]; then
  echo "❌ [ERROR] Push blocked: The following components were modified, but their Storybook files were not updated:"
  for file in "${unchanged_stories[@]}"; do
    echo "   - $file"
  done
  echo "📌 Please update the corresponding '.stories.tsx', '.stories.ts', or '.stories.mdx' file."
  exit 1
fi

echo "✅ All checks passed. Proceeding with push."
exit 0
