#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

protected_branches=("main" "develop")
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo "âŒ Pushing directly to the '$current_branch' branch is not allowed."
    exit 1
  fi
done

echo "ğŸ” Checking for modified .tsx files in packages/components..."

# ğŸ”¹ 1. develop ë¸Œëœì¹˜ ê¸°ì¤€ìœ¼ë¡œ í˜„ì¬ ë¸Œëœì¹˜ì˜ ëª¨ë“  ë³€ê²½ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
BASE_BRANCH="develop"
MERGE_BASE=$(git merge-base origin/$BASE_BRANCH HEAD)

CHANGED_FILES=$(git diff --name-only --diff-filter=AM "$MERGE_BASE" HEAD)
echo "ğŸ“ Full changed files list (compared to develop):"
echo "$CHANGED_FILES"

# ğŸ”¹ 2. packages/components ë‚´ë¶€ì˜ ëª¨ë“  .tsx íŒŒì¼ ì°¾ê¸°
MODIFIED_COMPONENTS=""
for FILE in $CHANGED_FILES; do
  case "$FILE" in
    packages/components/**/*.tsx)
      MODIFIED_COMPONENTS="$MODIFIED_COMPONENTS\n$FILE"
      echo "âœ… Component modified: $FILE"
      ;;
  esac
done

# ğŸ”¹ 3. ë™ì¼í•œ .stories.tsx, .stories.ts, .mdx íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
MISSING_STORYBOOK=""
MODIFIED_STORYBOOK=""
for FILE in $(echo "$MODIFIED_COMPONENTS"); do
  BASE_NAME=$(echo "$FILE" | sed 's/\.tsx$//')
  STORIES_FILES="${BASE_NAME}.stories.tsx ${BASE_NAME}.stories.ts ${BASE_NAME}.mdx"

  FOUND_STORYBOOK=""
  for STORY in $STORIES_FILES; do
    if [ -f "$STORY" ]; then
      FOUND_STORYBOOK="$STORY"
      break
    fi
  done

  if [ -z "$FOUND_STORYBOOK" ]; then
    echo "ğŸš¨ Missing Storybook file for: $FILE"
    MISSING_STORYBOOK="$MISSING_STORYBOOK\n$FILE"
  else
    echo "ğŸ“– Found Storybook file: $FOUND_STORYBOOK"
    MODIFIED_STORYBOOK="$MODIFIED_STORYBOOK\n$FOUND_STORYBOOK"
  fi
done

# ğŸ”¹ 4. ìŠ¤í† ë¦¬ë¶ íŒŒì¼ì´ ì—†ìœ¼ë©´ push ì¤‘ë‹¨
if [ -n "$MISSING_STORYBOOK" ]; then
  echo "âŒ Some components are missing Storybook files! Please add them."
  exit 1
fi

# ğŸ”¹ 5. ë³€ê²½ëœ ìŠ¤í† ë¦¬ë¶ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
STORYBOOK_CHANGES=""
for FILE in $(echo "$MODIFIED_STORYBOOK"); do
  if echo "$CHANGED_FILES" | grep -q "$FILE"; then
    STORYBOOK_CHANGES="$STORYBOOK_CHANGES\n$FILE"
    echo "âœ… Storybook modified: $FILE"
  fi
done

# ğŸ”¹ 6. ë³€ê²½ëœ ìŠ¤í† ë¦¬ë¶ íŒŒì¼ì´ ì—†ìœ¼ë©´ push ì¤‘ë‹¨
if [ -z "$STORYBOOK_CHANGES" ]; then
  echo "âŒ No modifications detected in corresponding Storybook files!"
  exit 1
fi

echo "âœ… All conditions met. Proceeding with push!"

exit 0
