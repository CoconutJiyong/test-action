#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

protected_branches=("main" "develop")
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo "❌ Pushing directly to the '$current_branch' branch is not allowed."
    exit 1
  fi
done

echo "🔍 Checking for modified .tsx files in packages/components..."

# 🔹 1. develop 브랜치 기준으로 현재 브랜치의 모든 변경 파일 가져오기
BASE_BRANCH="develop"
MERGE_BASE=$(git merge-base origin/$BASE_BRANCH HEAD)

CHANGED_FILES=$(git diff --name-only --diff-filter=AM "$MERGE_BASE" HEAD)
echo "📝 Full changed files list (compared to develop):"
echo "$CHANGED_FILES"

# 🔹 2. packages/components 내부의 모든 .tsx 파일 찾기
MODIFIED_COMPONENTS=""
for FILE in $CHANGED_FILES; do
  case "$FILE" in
    packages/components/**/*.tsx)
      MODIFIED_COMPONENTS="$MODIFIED_COMPONENTS\n$FILE"
      echo "✅ Component modified: $FILE"
      ;;
  esac
done

# 🔹 3. 동일한 .stories.tsx, .stories.ts, .mdx 파일이 있는지 확인
MISSING_STORYBOOK=""
MODIFIED_STORYBOOK=""
for FILE in $(echo "$MODIFIED_COMPONENTS"); do
  BASE_NAME=$(echo "$FILE" | sed 's/\.tsx$//')
  STORIES_FILES="${BASE_NAME}.stories.tsx ${BASE_NAME}.stories.ts ${BASE_NAME}.mdx"

  FOUND_STORYBOOK=""
  for STORY in $STORIES_FILES; do
    if [ -f "$STORY" ]; then
      FOUND_STORYBOOK="$STORY"
      break
    fi
  done

  if [ -z "$FOUND_STORYBOOK" ]; then
    echo "🚨 Missing Storybook file for: $FILE"
    MISSING_STORYBOOK="$MISSING_STORYBOOK\n$FILE"
  else
    echo "📖 Found Storybook file: $FOUND_STORYBOOK"
    MODIFIED_STORYBOOK="$MODIFIED_STORYBOOK\n$FOUND_STORYBOOK"
  fi
done

# 🔹 4. 스토리북 파일이 없으면 push 중단
if [ -n "$MISSING_STORYBOOK" ]; then
  echo "❌ Some components are missing Storybook files! Please add them."
  exit 1
fi

# 🔹 5. 변경된 스토리북 파일이 있는지 확인
STORYBOOK_CHANGES=""
for FILE in $(echo "$MODIFIED_STORYBOOK"); do
  if echo "$CHANGED_FILES" | grep -q "$FILE"; then
    STORYBOOK_CHANGES="$STORYBOOK_CHANGES\n$FILE"
    echo "✅ Storybook modified: $FILE"
  fi
done

# 🔹 6. 변경된 스토리북 파일이 없으면 push 중단
if [ -z "$STORYBOOK_CHANGES" ]; then
  echo "❌ No modifications detected in corresponding Storybook files!"
  exit 1
fi

echo "✅ All conditions met. Proceeding with push!"

exit 0
