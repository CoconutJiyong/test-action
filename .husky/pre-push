#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ğŸ”¹ ë³´í˜¸ëœ ë¸Œëœì¹˜(main, develop) ì§ì ‘ í‘¸ì‹œ ë°©ì§€
protected_branches=("main" "develop")
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

for branch in "${protected_branches[@]}"; do
  if [ "$current_branch" = "$branch" ]; then
    echo "âŒ Pushing directly to the '$current_branch' branch is not allowed."
    exit 1
  fi
done

echo "ğŸ” Checking for modified .tsx files in packages/components..."

# ğŸ”¹ feature ë¸Œëœì¹˜ê°€ developì—ì„œ ë¶„ê¸°ëœ ì´í›„ ë³€ê²½ëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
BASE_COMMIT=$(git merge-base origin/develop HEAD)
CHANGED_FILES=$(git diff --name-only --diff-filter=AM "$BASE_COMMIT" HEAD | sort -u)

echo "ğŸ“ Full changed files list (since feature branch creation):"
echo "$CHANGED_FILES"

# ğŸ”¹ packages/components ë‚´ë¶€ ë³€ê²½ëœ íŒŒì¼ë§Œ í•„í„°ë§
MODIFIED_COMPONENTS=$(echo "$CHANGED_FILES" | grep '^packages/components/.*\.tsx$' || true)

if [ -z "$MODIFIED_COMPONENTS" ]; then
  echo "âœ… No .tsx file changes detected in packages/components."
  exit 0
fi

echo "ğŸ” Analyzing modified components:"
echo "$MODIFIED_COMPONENTS"

# ğŸ”¹ ë³€ê²½ëœ .tsx íŒŒì¼ì—ì„œ .stories.tsx, .stories.ts, .mdx ì¡´ì¬ ì—¬ë¶€ í™•ì¸
MISSING_STORYBOOK=""
MODIFIED_STORYBOOK=""

for FILE in $MODIFIED_COMPONENTS; do
  BASE_NAME=$(echo "$FILE" | sed 's/\.tsx$//')
  STORIES_FILES="${BASE_NAME}.stories.tsx ${BASE_NAME}.stories.ts ${BASE_NAME}.mdx"

  FOUND_STORYBOOK=""
  for STORY in $STORIES_FILES; do
    if [ -f "$STORY" ]; then
      FOUND_STORYBOOK="$STORY"
      echo "ğŸ“– Found Storybook file: $FOUND_STORYBOOK"
      break
    fi
  done

  if [ -z "$FOUND_STORYBOOK" ]; then
    echo "ğŸš¨ Missing Storybook file for: $FILE"
    MISSING_STORYBOOK=$(printf "%s\n%s" "$MISSING_STORYBOOK" "$FILE")
  fi
done

# ğŸ”¹ ë””ë²„ê¹…: Missing Storybook íŒŒì¼ ì¶œë ¥
echo "ğŸ” DEBUG: FINAL MISSING_STORYBOOK content:"
echo "$MISSING_STORYBOOK"

# ğŸ”¹ 4. ë™ì¼í•œ ì´ë¦„ì˜ stories íŒŒì¼ì´ ì—†ìœ¼ë©´ push ì¤‘ë‹¨
if [ -n "$(echo "$MISSING_STORYBOOK" | tr -d '\n')" ]; then
  echo "âŒ Some components are missing Storybook files! Please add them."
  exit 1
fi

# ğŸ”¹ 5. .tsx ë³€ê²½ì´ ìˆê³  stories íŒŒì¼ ë³€ê²½ì´ ì—†ìœ¼ë©´ push ì¤‘ë‹¨
for FILE in $MODIFIED_COMPONENTS; do
  BASE_NAME=$(echo "$FILE" | sed 's/\.tsx$//')
  STORIES_FILES="${BASE_NAME}.stories.tsx ${BASE_NAME}.stories.ts ${BASE_NAME}.mdx"

  for STORY in $STORIES_FILES; do
    if [ -f "$STORY" ]; then
      echo "ğŸ” Checking if Storybook file was modified: $STORY"
      
      # âœ… ëª¨ë“  ì»¤ë°‹ì—ì„œ ìŠ¤í† ë¦¬ë¶ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      if git log --name-only "$BASE_COMMIT"..HEAD -- "$STORY" | grep -q "$STORY"; then
        MODIFIED_STORYBOOK=$(printf "%s\n%s" "$MODIFIED_STORYBOOK" "$STORY")
        echo "âœ… Storybook modified in some commit: $STORY"
      else
        echo "ğŸš¨ Storybook file exists but was NOT modified in any commit: $STORY"
      fi
      break
    fi
  done
done

# ğŸ”¹ ë””ë²„ê¹…: Modified Storybook íŒŒì¼ ì¶œë ¥
echo "ğŸ” DEBUG: FINAL MODIFIED_STORYBOOK content:"
echo "$MODIFIED_STORYBOOK"

# ğŸ”¹ 6. components ë³€ê²½ë§Œ ìˆê³  stories ë³€ê²½ì´ ì—†ìœ¼ë©´ push ì¤‘ë‹¨
if [ -z "$(echo "$MODIFIED_STORYBOOK" | tr -d '\n')" ]; then
  echo "âŒ Component changed but Storybook was NOT updated. Please update the Storybook file."
  exit 1
fi

echo "âœ… All conditions met. Proceeding with push!"
exit 0
